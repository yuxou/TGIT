package model.dao;

import java.sql.*;
import java.util.*;
import model.domain.Expense;

public class ExpenseDAO {
    private JDBCUtil jdbcUtil = null;

    public ExpenseDAO() {
        jdbcUtil = new JDBCUtil();
    }

    /**
     * 지출 추가
     */
    public void addExpense(Expense expense) {
        String sql = "INSERT INTO expenses (place, expenseDate, category, cost, notes) VALUES (?, ?, ?, ?, ?)";
        Object[] params = {
            expense.getPlace(),
            expense.getSqlExpenseDate(),
            expense.getCategory(),
            expense.getCost(),
            expense.getNotes() != null ? expense.getNotes() : null // notes가 null일 경우 처리
        };

        try {
            jdbcUtil.setSqlAndParameters(sql, params);
            int rows = jdbcUtil.executeUpdate();
            System.out.println(rows + " row(s) inserted.");
        } catch (SQLException e) {
            e.printStackTrace();
        } finally {
            jdbcUtil.close();
        }
    }

    /**
     * 지출 수정
     */
    public void editExpense(Expense expense) {
        String sql = "UPDATE expenses SET place = ?, expenseDate = ?, category = ?, cost = ?, notes = ? WHERE expenseId = ?";
        Object[] params = {
            expense.getPlace(),
            expense.getSqlExpenseDate(),
            expense.getCategory(),
            expense.getCost(),
            expense.getNotes() != null ? expense.getNotes() : null, // notes가 null일 경우 처리
            expense.getExpenseId()
        };

        try {
            jdbcUtil.setSqlAndParameters(sql, params);
            int rows = jdbcUtil.executeUpdate();
            System.out.println(rows + " row(s) updated.");
        } catch (SQLException e) {
            e.printStackTrace();
        } finally {
            jdbcUtil.close();
        }
    }

    /**
     * 지출 삭제
     */
    public void deleteExpense(int expenseId) {
        String sql = "DELETE FROM expenses WHERE expenseId = ?";
        Object[] params = {expenseId};

        try {
            jdbcUtil.setSqlAndParameters(sql, params);
            int rows = jdbcUtil.executeUpdate();
            System.out.println(rows + " row(s) deleted.");
        } catch (SQLException e) {
            e.printStackTrace();
        } finally {
            jdbcUtil.close();
        }
    }

    /**
     * 특정 계획의 전체 지출 조회
     */
    public double getTotalExpense(int planId) {
        String sql = "SELECT SUM(cost) AS totalCost FROM expenses WHERE planId = ?";
        Object[] params = {planId};

        double total = 0;
        try {
            jdbcUtil.setSqlAndParameters(sql, params);
            ResultSet rs = jdbcUtil.executeQuery();
            if (rs != null && rs.next()) {
                total = rs.getDouble("totalCost");
            }
        } catch (SQLException e) {
            e.printStackTrace();
        } finally {
            jdbcUtil.close();
        }
        return total;
    }

    /**
     * 경비 분할
     */
    public Map<String, Double> splitExpense(int expenseId, int numPeople) {
        if (numPeople <= 0) {
            throw new IllegalArgumentException("Number of people must be greater than 0.");
        }

        String sql = "SELECT cost FROM expenses WHERE expenseId = ?";
        Object[] params = {expenseId};

        Map<String, Double> splitMap = new HashMap<>();
        try {
            jdbcUtil.setSqlAndParameters(sql, params);
            ResultSet rs = jdbcUtil.executeQuery();
            if (rs != null && rs.next()) {
                double cost = rs.getDouble("cost");
                double splitAmount = cost / numPeople;
                for (int i = 1; i <= numPeople; i++) {
                    splitMap.put("Person " + i, splitAmount);
                }
            }
        } catch (SQLException e) {
            e.printStackTrace();
        } finally {
            jdbcUtil.close();
        }
        return splitMap;
    }

    /**
     * 특정 ID의 지출 조회
     */
    public Expense findExpenseById(int expenseId) {
        String sql = "SELECT * FROM expenses WHERE expenseId = ?";
        Object[] params = {expenseId};

        Expense expense = null;
        try {
            jdbcUtil.setSqlAndParameters(sql, params);
            ResultSet rs = jdbcUtil.executeQuery();
            if (rs != null && rs.next()) {
                expense = new Expense(
                    rs.getInt("expenseId"),
                    rs.getString("place"),
                    rs.getDate("expenseDate").toLocalDate().getYear(),
                    rs.getDate("expenseDate").toLocalDate().getMonthValue(),
                    rs.getDate("expenseDate").toLocalDate().getDayOfMonth(),
                    rs.getString("category"),
                    rs.getDouble("cost"),
                    rs.getString("notes")
                );
            }
        } catch (SQLException e) {
            e.printStackTrace();
        } finally {
            jdbcUtil.close();
        }
        return expense;
    }
}
